#!/bin/sh

# Red Light Green Light validate.sh version <%= @ rlgl-version %>

# Print out the sigstore record for a rlgl report.  This script
# generates a digest of the report, validates the signature with the
# public key of the signing service, and looks it up in the rekor
# log.  It is provided in script that you can run for transparency
# and audit purposes.

# ---- Identify the document that we are verifing the sigstore document for ---
DOC=<%= @ id %>

function error_exit
{
    echo ERROR: ${1:-"Unknown Error"} 1>&2
    exit 1
}

# ---- Verify that all required programs are installed ------------------------
awk --help > /dev/null 2>&1 || error_exit "Cannot run awk.  Please install it."
for PROGRAM in "rekor-cli version" "openssl version" "curl --help" "grep --help" "base64 --help"; do
    $PROGRAM > /dev/null 2>&1 || error_exit "Cannot run $(echo ${PROGRAM} | awk '{ printf $1 }').  Please install it."
done

# ---- Create names of temporary files ----------------------------------------
TMPDIR="$(mktemp -d)"
trap 'rm -rf -- "$TMPDIR"' EXIT
DIGEST=${TMPDIR}/${DOC}.digest
SERVER_PUBKEY=${TMPDIR}/rlgl.pem
SERVER_SIGNATURE=${TMPDIR}/${DOC}.digest.sig
CLIENT_PUBKEY=$1
CLIENT_SIGNATURE=${TMPDIR}/${DOC}.digest.csig

# ---- Download all artifacts -------------------------------------------------
curl -s <%= @ server-uri %>/pubkey > ${SERVER_PUBKEY}
curl -s <%= @ server-uri %>/doc?id=${DOC} | openssl dgst -sha3-256 - | awk '{ printf $2 }' > ${DIGEST}
curl -s <%= @ server-uri %>/doc?id=${DOC}.sig | base64 -d > ${SERVER_SIGNATURE}
curl -s <%= @ server-uri %>/doc?id=${DOC}.csig | base64 -d > ${CLIENT_SIGNATURE}

# ---- Validate the signature of the document digest --------------------------
echo Checking document signature: $(openssl dgst -sha256 -verify ${SERVER_PUBKEY} -signature ${SERVER_SIGNATURE} ${DIGEST})
echo

# ---- Checking client signature ----------------------------------------------
if [ -z "$CLIENT_SIGNATURE" ]; then
    echo Missing client public key argument.  Not checking client signature.
else
    echo Checking client signature : $(openssl dgst -sha3-256 -verify ${CLIENT_PUBKEY} -signature ${CLIENT_SIGNATURE} ${DIGEST})
fi

# ---- Look up this document in rekor and print out the record ----------------
echo Searching for sigstore record:
HASH=$(rekor-cli verify --artifact ${DIGEST} --signature ${SERVER_SIGNATURE} --public-key ${SERVER_PUBKEY} --pki-format x509 | grep "Entry Hash:" | awk '{ printf $3 }')
rekor-cli get --uuid $HASH
